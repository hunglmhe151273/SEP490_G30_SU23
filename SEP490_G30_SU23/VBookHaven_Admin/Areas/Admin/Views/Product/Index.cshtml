@using VBookHaven.Models
@model List<Product>
@{
	Dictionary<int, string?> thumbnails = (Dictionary<int, string?>)ViewBag.thumbnails;
}
@{
	ViewData["Title"] = "Danh sách sản phẩm";
}

<!--page-wrapper-->
<div class="page-wrapper">
	<!--page-content-wrapper-->
	<div class="page-content-wrapper">
		<div class="page-content">
			<!--breadcrumb-->
			<div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
				<div class="breadcrumb-title pe-3">Sản phẩm</div>
				<div class="ps-3">
					<nav aria-label="breadcrumb">
						<ol class="breadcrumb mb-0 p-0">
							<li class="breadcrumb-item">
								<a href="javascript:;">
									<i class="bx bx-home-alt"></i>
								</a>
							</li>
							<li class="breadcrumb-item active" aria-current="page">Số liệu sản phẩm</li>
						</ol>
					</nav>
				</div>
			</div>
			<!--end breadcrumb-->
			<div class="card">
				<div class="card-body">
					<div class="card-title">
						<h4 class="mb-0">Bảng quản lí sản phẩm</h4>
					</div>
					<hr />
					<div class="mb-3 row">
						<div class="accordion col-8" id="accordionExample">
							<div class="accordion-item">
								<h3 class="accordion-header" id="headingOne">
									<button class="accordion-button collapsed" type="button"
											data-bs-toggle="collapse" data-bs-target="#filler" aria-expanded="false"
											aria-controls="filler">
										BỘ LỌC
									</button>
								</h3>
								<div id="filler" class="accordion-collapse collapse"
									 aria-labelledby="headingOne" data-bs-parent="#accordionExample">
									<div class="accordion-body">
										<form class="row" action="">
											<div class="col-md-12 mb-2">
												<label class="form-label">Tìm kiếm</label>
												<input type="text" class="form-control filter" id="search"
													   placeholder="Tìm theo tên sản phẩm hoặc mã vạch...">
											</div>
											<div class="col-md-6 mb-2">
												<label class="form-label">Loại sản phẩm</label>
												<select class="form-select filter" id="category"
														asp-items="@ViewBag.subCategories">
												</select>
											</div>
											<div class="col-md-6 mb-2">
												<label class="form-label">Trạng thái</label>
												<select class="form-select filter" id="status"
														asp-items="@ViewBag.statusList">
												</select>
											</div>
											@*<div class="col-md-4"></div>
											<input type="submit" class="btn btn-primary mt-3 col-md-4" value="Lọc">
											<div class="col-md-4"></div>*@
										</form>
									</div>
								</div>
							</div>
						</div>
						<div class="col-4">
							<button type="button" class="btn btn-success">Nhập file</button>
							<button type="button" class="btn btn-success">Xuất file</button>
							<button type="button" class="btn btn-primary dropdown-toggle"
									data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								Thêm sản
								phẩm
							</button>
							<div class="dropdown-menu">
								<a class="dropdown-item" href="/admin/product/addbook">Thêm sách</a>
								<a class="dropdown-item" href="/admin/product/addstationery">Thêm văn phòng phẩm</a>
							</div>
						</div>
						<div class="table-responsive mt-3">
							<table id="example2" class="table table-striped table-bordered" style="width:100%">
								<thead>
									<tr>
										<th>Ảnh</th>
										<th>Mã vạch</th>
										<th>Tên sản phẩm</th>
										<th hidden>Loại</th>
										<th>Tồn kho</th>
										<th>Có thể bán</th>
										<th>Giá nhập (VNĐ)</th>
										<th>Giá lẻ (VNĐ)</th>
										<th>Giá sỉ (VNĐ)</th>
										<th>Chi tiết</th>
										<th>Trạng thái</th>
										<th>Hành động</th>
									</tr>
								</thead>
								<tbody id="myTable">
									@foreach (Product p in Model)
									{
										<tr>
											<td>
												@if (thumbnails[p.ProductId] != null)
												{
													<img src="~/images/img/@thumbnails[p.ProductId]"
														width="90px" height="120px" 
														style="object-fit: contain" alt="">
												}
											</td>
											<td>@p.Barcode</td>
											<td>@p.Name</td>
											<td hidden>@p.SubCategoryId</td>
											<td>@p.UnitInStock.Value.ToString("#,0")</td>
											<td>@p.AvailableUnit.Value.ToString("#,0")</td>
											<td>@p.PurchasePrice.Value.ToString("#,0")</td>
											<td>@p.RetailPrice.Value.ToString("#,0")</td>
											<td>@p.WholesalePrice.Value.ToString("#,0")</td>
											<td>
												@if (p.IsBook == true)
												{
													<a href="/admin/product/viewbook/@p.ProductId" class="btn btn-sm btn-default">
														<i class="lni lni-eye"></i>
													</a>
												}
												else
												{
													<a href="/admin/product/viewstationery/@p.ProductId" class="btn btn-sm btn-default">
														<i class="lni lni-eye"></i>
													</a>
												}
											</td>
											<td>
												@if (p.Status == true)
												{
													<span class="badge bg-success">Hoạt động</span>
													<span hidden>1</span>
												}
												else
												{
													<span class="badge bg-danger">Đình chỉ</span>
													<span hidden>0</span>
												}
											</td>
											<td>
												@if (p.IsBook == true)
												{
													<button type="button" class="btn btn-sm btn-default"
															onclick="window.location.href='/admin/product/editbook/@p.ProductId'">
														<i class="lni lni-pencil-alt"></i>
													</button>
												}
												else
												{
													<button type="button" class="btn btn-sm btn-default"
															onclick="window.location.href='/admin/product/editstationery/@p.ProductId'">
														<i class="lni lni-pencil-alt"></i>
													</button>
												}
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--end page-content-wrapper-->
</div>
<!--end page-wrapper-->

@section Scripts
{
	<script>
		$(document).ready(function () {
			var table = $('#example2').DataTable({
				//columnDefs: [
				//    { type: 'natural', targets: [4, 5, 6, 7] }
				//]
			});
			table.buttons().container().appendTo('#example2_wrapper .col-md-6:eq(0)');
		});
		
		$(document).ready(function () {
			$(".filter").on("input", function () {
				var search = $("#search").val().toLowerCase();
				var category = $("#category").val();
				var status = $("#status").val();
				//console.log(search, category, status);

				$("#myTable tr").filter(function () {
					var catSearch;
					if (category == 0) {
						catSearch = true;
					}
					else {
						catSearch = $(this).find('td:eq(3)').text() == category;
					}

					var statusSearch
					if (status == -1) {
						statusSearch = true;
					}
					else {
						statusSearch = $(this).find('td:eq(10) > span:eq(1)').text() == status;
					}

					$(this).toggle(
						statusSearch
						&& catSearch
						&& ($(this).find('td:eq(1)').text().toLowerCase().indexOf(search) > -1
							|| $(this).find('td:eq(2)').text().toLowerCase().indexOf(search) > -1)
					);
				})
			});
		});
	</script>
}