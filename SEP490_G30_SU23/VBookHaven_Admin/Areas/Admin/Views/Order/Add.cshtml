@using VBookHaven.Models
@using VBookHaven_Admin.Areas.Admin.Controllers
@using System.Text.Json
@using VBookHaven_Admin

@model AddOrderManagementModel

<!-- Old code -->
@*<style>
	table, th, td {
		border: 1px solid;
	}

	th, td {
		margin: 10px;
	}

	table {
		margin: 50px;
		border-collapse: collapse;
	}
</style>

<!--page-wrapper-->
<div class="page-wrapper">
	<!--page-content-wrapper-->
	<div class="page-content-wrapper">
		<div class="page-content">
			<form method="post">
				<select onchange="ChangeShipInfo(this)">
					<option value="" selected>--- Chọn khách hàng ---</option>
					@foreach (ShippingInfo s in Model.AllShipInfo)
					{
						string shipJson = JsonSerializer.Serialize(s);

						string name = s.CustomerName;
						if (s.Phone != null)
							name += ", " + s.Phone;
						<option value="@shipJson">@name</option>
					}
				</select>

				<input asp-for="Order.CustomerName" hidden />
				<input asp-for="Order.Phone" hidden />
				<input asp-for="Order.ShipAddress" hidden />

				<div id="show-customer-name"></div>
				<div id="show-phone"></div>
				<div id="show-ship-address"></div>

				<select onchange="ChangeProduct(this)">
					<option value="" selected>-- Thêm sản phẩm --</option>
					@foreach (Product p in Model.AllProducts)
					{
						string productJson = JsonSerializer.Serialize(p);
						<option id="product-@p.ProductId" value="@productJson">@p.Barcode - @p.Name</option>
					}
				</select>

				<table id="show-product-table">
					<tr>
						<th>Mã vạch</th>
						<th>Tên sản phẩm</th>
						<th>Số lượng</th>
						<th>Đơn giá</th>
						<th>Chiết khấu</th>
						<th>Thành tiền</th>
						<th></th>
						<th hidden>Product ID</th>
					</tr>
				</table>

				<input type="submit" value="Thêm đơn hàng" />
			</form>
		</div>
	</div>
	<!--end page-content-wrapper-->
</div>
<!--end page-wrapper-->

<script type="text/javascript">
	function ChangeShipInfo(selectObject)
	{
		var value = selectObject.value;

		if (value != "")
		{
			var shipInfo = JSON.parse(value);

			$("#show-customer-name").text(shipInfo.CustomerName);
			$("#show-phone").text(shipInfo.Phone);
			$("#show-ship-address").text(shipInfo.ShipAddress);

			$("#Order_CustomerName").val(shipInfo.CustomerName);
			$("#Order_Phone").val(shipInfo.Phone);
			$("#Order_ShipAddress").val(shipInfo.ShipAddress);
		}
		else
		{
			$("#show-customer-name").text("");
			$("#show-phone").text("");
			$("#show-ship-address").text("");

			$("#Order_CustomerName").val("");
			$("#Order_Phone").val("");
			$("#Order_ShipAddress").val("");
		}
	}

	function ChangeProduct(selectObject)
	{
		var value = selectObject.value;
		if (value != "")
		{
			var productInfo = JSON.parse(value);

			var barcode = productInfo.Barcode;
			var name = productInfo.Name;
			var quantity = 1;
			var price = productInfo.RetailPrice;
			var discount = productInfo.RetailDiscount;
			var total = price * (1 - discount / 100) * quantity;
			var id = productInfo.ProductId;

			var addRow = 
				`<tr>
					<td>${barcode}</td>
					<td>${name}</td>
					<td><input type='number' name='QuantityList' value='${quantity}' 
						min='1' required onchange='ChangeTotal(this)' /></td>
					<td><input type='number' name='PriceList' value='${price}'
						min='0' required onchange='ChangeTotal(this)' /></td>
					<td><input type='number' name='DiscountList' value='${discount}'
						min='0' max='100' step='0.1' required onchange='ChangeTotal(this)' /></td>
					<td>${total}</td>
					<td><button onclick='RemoveProduct(this)'>X</button></td>
					<td hidden><input hidden name='ProductIdList' value='${id}' /></td>
				</tr>`

			$("#show-product-table").append(addRow);

			$(selectObject).find(":selected").hide();
			selectObject.value = "";
		}
	}

	function RemoveProduct(element)
	{
		var row = $(element).parent().parent();
		var id = $(row).children(":nth-child(8)").children(":first-child").val();

		var productOptionId = "#product-" + id;

		$(row).remove();
		$(productOptionId).show();
	}

	function ChangeTotal(element)
	{
		var row = $(element).parent().parent();
		var quantity = $(row).children(":nth-child(3)").children(":first-child").val();
		var price = $(row).children(":nth-child(4)").children(":first-child").val();
		var discount = $(row).children(":nth-child(5)").children(":first-child").val();

		var total = price * (1 - discount / 100) * quantity;

		$(row).children(":nth-child(6)").text(total);
	}
</script>*@

<style>
    #searchList {
        position: absolute;
        z-index: 3;
        display: none;
        box-shadow: 2px 2px gray;
    }

    .item {
        padding: 10px 15px;
    }

    #list-product {
        border: 1px solid lightgray;
        overflow-y: auto;
        max-height: 350px;
    }

    .cover {
        padding: 0;
        width: 60px;
        height: 50px;
    }

    img {
        width: 100%;
        height: 100%;
    }

    td:nth-child(3) {
        max-width: 100px;
    }

    /* Custom CSS for truncating text and keeping the link next to it */

    .ellipsis {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
        /* Set the number of lines to display */
        overflow: hidden;
    }

    /* Custom CSS for adjusting the size of the ellipsis div */

    .ellipsis-div {
        max-width: 150px;
        /* Set the maximum width for the div (adjust as needed) */
    }

    input[type=number] {
        width: 100%;
        text-align: center;
    }

    /* Custom CSS for text overflow ellipsis */
</style>

<!--page-wrapper-->
<div class="page-wrapper">
    <!--page-content-wrapper-->
    <div class="page-content-wrapper">
        <div class="page-content">
            <!--breadcrumb-->
            <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
                <div class="breadcrumb-title pe-3">Đơn hàng</div>
                <div class="ps-3">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 p-0">
                            <li class="breadcrumb-item">
                                <a href="/Admin/Order/Index">
                                    <i class="bx bx-home-alt"></i>
                                </a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">Tạo đơn hàng</li>
                        </ol>
                    </nav>
                </div>
            </div>
            <!--end breadcrumb-->
            <form method="post">
                <div class="row">
                    <div class="col-9 mx-auto">
                        <div class="card">
                            <div class="card-body d-flex justify-content-center align-items-center wizard-container">
                                <!-- Status progress bar -->
                                <div class="wizard-progress w-100">
                                    <div class="step complete">
                                        <span class="title">@OrderStatus.Create</span>
                                        <div class="node"></div>
                                    </div>
                                    <div class="step">
                                        <span class="title">@OrderStatus.Wait</span>
                                        <div class="node"></div>
                                    </div>
                                    <div class="step">
                                        <span class="title">@OrderStatus.Process</span>
                                        <div class="node"></div>
                                    </div>
                                    <div class="step">
                                        <span class="title">@OrderStatus.Shipping</span>
                                        <div class="node"></div>
                                    </div>
                                    <div class="step">
                                        <span class="title">@OrderStatus.Shipped</span>
                                        <div class="node"></div>
                                    </div>
                                    <div class="step">
                                        <span class="title">@OrderStatus.Done</span>
                                        <div class="node"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 card border-top border-0 border-4 border-primary">
                            <div class="pt-4 px-5">
                                <div class="card-title d-flex align-items-center">
                                    <div>
                                        <i class="bx bxs-user-rectangle bx-tada me-2 fs-4"></i>
                                    </div>
                                    <h4 class="mb-0 fw-bold">Khách hàng</h4>
                                </div>
                                <hr>
                                <div class="card-body row g-3">
                                    <!-- không fix code >> chú ý id div này >> id liên quan đến js -->
                                    <div class="col-md-12 px-0" id="customerContainer">
                                        <select id="customerSelect" class="single-select">
                                        </select>
                                        <div class="btn btn-outline-success w-100 mt-2" data-bs-toggle="modal"
                                             data-bs-target="#addCustomer">
                                            <i class='bx bx-plus-circle fs-5'></i> Thêm nhanh khách hàng
                                        </div>
                                    </div>
                                    <!-- không fix code >> chú ý id div này >> id liên quan đến js -->
                                    <div id="customerInfoContainer" class="mb-4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-3 mx-auto card border-top border-0 border-4 border-primary">
                        <div class="card-title text-center pt-4">
                            <h4 class="mb-0 fw-bold">Thông tin bổ sung</h4>
                        </div>
                        <div class="card-body">
                            <label class="form-label">Ghi chú hóa đơn</label><br>
                            <textarea class="form-control" cols="30" rows="6"
                                asp-for="Order.Note"></textarea>
                        </div>
                    </div>
                    <div class="col-12 mx-auto pe-0">
                        <div class="card border-top border-0 border-4 border-primary">
                            <div class="card-body p-5">
                                <div class="card-title d-flex align-items-center">
                                    <div>
                                        <i class="bx bxs-receipt bx-tada me-2 fs-4"></i>
                                    </div>
                                    <h4 class="mb-0 fw-bold">Chi tiết đơn hàng</h4>
                                </div>
                                <hr>
                                <div class="row g-3">
                                    <div class="col-md-9 p-0" style="position: relative;">
                                        <div class="input-group">
                                            <span class="input-group-text bg-transparent">
                                                <i class="bx bx-search"></i>
                                            </span>
                                            <input class="form-control border-start-0 filter" type="text"
                                                   placeholder="Thêm sản phẩm theo mã SP, tên SP" id="search">
                                        </div>
                                        <div class="w-100 mt-1" id="searchList">
                                            <!-- không fix code >> chú ý id div này >> id liên quan đến js -->
                                            <div class="list-group">
                                                @*<div class="list-group-item btn btn-outline-success"
                                                     data-bs-toggle="modal" data-bs-target="#addProduct">
                                                    <i class='bx bx-plus-circle'></i> Thêm nhanh sản phẩm mới
                                                </div>*@
                                                <div id="list-product"></div>
                                                <!-- <a href="javascript:;" class="list-group-item item">
                                                    <div class="row d-flex align-items-center">
                                                        <div class="col-6 d-flex align-items-center">
                                                            <div class="flex-shrink-0 cover">
                                                                <img
                                                                    src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSrLma5aAvx0GfOw_SpUWij6cng9eleiZoXxMyh-fsyRloR5RuxJW_KdBw5Hbup0ocbo5s&usqp=CAU">
                                                            </div>
                                                            <div class="flex-grow-1 ms-3">
                                                                <p class="m-0 search-info fs-6">Sách 1</p>
                                                                <small class="m-0 text-secondary">Mã SP: <span
                                                                        class="search-info">021312</span></small>
                                                                <p class="m-0">Đơn vị: <span
                                                                        class="text-info">Cuốn</span></p>
                                                            </div>
                                                        </div>
                                                        <div class="col-6 text-end">
                                                            <p class="m-0"><strong>Giá nhập:</strong> 100.000
                                                                VNĐ
                                                            </p>
                                                            <p class="m-0 text-info fw-bold">Tồn: 267</p>
                                                        </div>
                                                    </div>
                                                </a>
                                                <a href="javascript:;" class="list-group-item item">
                                                    <div class="row d-flex align-items-center">
                                                        <div class="col-6 d-flex align-items-center">
                                                            <div class="flex-shrink-0 cover">
                                                                <img
                                                                    src="https://product.hstatic.net/1000230347/product/but_bi_thien_long_tl-027__1__1024x1024.jpg">
                                                            </div>
                                                            <div class="flex-grow-1 ms-3">
                                                                <p class="m-0 search-info fs-6">VPP 1</p>
                                                                <small class="m-0 text-secondary">Mã SP: <span
                                                                        class="search-info">923492</span></small>
                                                                <p class="m-0">Đơn vị: <span
                                                                        class="text-info">Chiếc</span></p>
                                                            </div>
                                                        </div>
                                                        <div class="col-6 text-end">
                                                            <p class="m-0"><strong>Giá nhập:</strong> 2.000 VNĐ
                                                            </p>
                                                            <p class="m-0 text-info fw-bold">Tồn: 145</p>
                                                        </div>
                                                    </div>
                                                </a> -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="price-type" class="form-select">
                                            <option value="Giá lẻ">Giá lẻ</option>
                                            <option value="Giá sỉ">Giá sỉ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <table id="myTable"
                                               class="table table-striped table-bordered text-center">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th class="col-1">Ảnh</th>
                                                    <th class="col-2">Tên SP</th>
                                                    <th class="col-1">Đơn vị</th>
                                                    <th class="col-1">Số lượng</th>
                                                    <th class="col-2">Đơn giá</th>
                                                    <th class="col-2">Chiết khấu</th>
                                                    <th class="col-2">Thành tiền</th>
                                                    <th></th>
                                                    <th hidden>ID</th>
                                                </tr>
                                            </thead>
                                            <!-- không fix code >> chú ý id div này >> id liên quan đến js -->
                                            <tbody id="orderContainer">
                                                @*<tr>
                                                    <td></td>
                                                    <td> <img src="assets/images/avatars/avatar-1.png"></td>
                                                    <td>
                                                        <div class="ellipsis">
                                                            Sách a
                                                        </div>
                                                    </td>
                                                    <td>Cuốn</td>
                                                    <td>
                                                        <div class="input-group">
                                                            <input type="number" value="5" min="1"
                                                                   class="form-control num">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="input-group">
                                                            <input class="form-control price num" value="0"
                                                                   type='number' />
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="input-group">
                                                            <input class="form-control discount num" step="0.5"
                                                                   min="0" value="0" type='number' />
                                                            <span class="input-group-text">%</span>
                                                        </div>
                                                    </td>
                                                    <td><span class="sum"></span> VNĐ</td>
                                                    <td>
                                                        <a href="#" type="button"
                                                           class="btn btn-close btn-danger delete"></a>
                                                    </td>
                                                </tr>*@
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-7 d-flex justify-content-start align-items-end">
                                        <input type="submit" class="btn btn-success px-4 mx-1" value="Lưu">
                                        <button type="button" class="btn btn-danger px-4 mx-1"
                                                onclick="window.location.href='/Admin/Order/Index'">
                                            Hủy
                                        </button>
                                    </div>
                                    <div class="col-5">
                                        <table class="table" id="countTable">
                                            <tr>
                                                <td>Cộng tiền hàng</td>
                                                <td class="text-end"><span id="totalPrice"></span> VNĐ</td>
                                            </tr>
                                            <tr>
                                                <td>Thuế GTGT</td>
                                                <td class="d-flex justify-content-end">
                                                    <div class="input-group w-50">
                                                        <input id="totalVat" type="number" value="0" min="0"
                                                               step="0.1" class="form-control"
                                                               asp-for="Order.VAT" />
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th><strong>Tổng tiền thanh toán</strong></th>
                                                <td class="text-end">
                                                    <strong>
                                                        <span id="totalPay"></span>
                                                        VNĐ
                                                    </strong>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Số tiền khách đã trả</td>
                                                <td class="w-50">
                                                    <div class="input-group">
                                                        <input id="paid" type="number" value="0" min="0"
                                                               step="1" class="form-control"
                                                               asp-for="Order.AmountPaid" />
                                                        <span class="input-group-text">VNĐ</span>
                                                    </div>
                                                    <div>
                                                        <select class="single-select" name="PaymentMethod">
                                                            <option value="@PaymentMethod.Card">@PaymentMethod.Card</option>
                                                            <option value="@PaymentMethod.Transfer" selected>@PaymentMethod.Transfer</option>
                                                            <option value="@PaymentMethod.Cash">@PaymentMethod.Cash</option>
                                                        </select>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Số tiền còn thiếu</td>
                                                <td class="text-end"><span id="debt"></span> VNĐ</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            @*<div class="modal fade" id="addProduct" tabindex="-1" aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <form action="" class="addForm">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Thêm nhanh sản phẩm mới</h5>
                            </div>
                            <div class="modal-body row">
                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label">Tên sản phẩm *</label>
                                    <input type="text" class="form-control validate important" id="productName"
                                           placeholder="Nhập tên sản phẩm" required>
                                    <div id="product-feedback" class="feedback"></div>
                                </div>
                                <div class="col-12 col-md-6 mb-3">
                                    <label for="inputCity" class="form-label">Loại sản phẩm</label>
                                    <div class="input-group mt-1">
                                        <div class="form-check-inline">
                                            <input class="form-check-input" type="radio" name="IsBook" checked>
                                            <label class="form-check-label" for="flexRadioDefault2">Sách</label>
                                        </div>
                                        <div class="form-check-inline">
                                            <input class="form-check-input" type="radio" name="IsBook">
                                            <label class="form-check-label" for="flexRadioDefault2">VPP</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label">Mã vạch</label>
                                    <input type="text" class="form-control validate is-valid" id="barCode"
                                           placeholder="Nhập mã vạch">
                                    <div id="barCode-feedback" class="feedback"></div>
                                </div>
                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label">Giá nhập *</label>
                                    <input type="text" class="form-control validate important" id="price"
                                           placeholder="Nhập giá" required>
                                    <div id="price-feedback" class="feedback"></div>
                                </div>
                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label">Số lượng nhập *</label>
                                    <input type="text" class="form-control validate important" id="quantity"
                                           placeholder="Nhập số lượng" required>
                                    <div id="quantity-feedback" class="feedback"></div>
                                </div>
                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label">Đơn vị tính *</label>
                                    <input type="text" class="form-control validate important" id="unit"
                                           placeholder="Nhập đơn vị" required>
                                    <div id="unit-feedback" class="feedback"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <input type="button" class="btn btn-primary reset submit" value="Lưu"
                                       id="submitProduct" data-bs-dismiss="modal">
                                <input type="reset" class="btn btn-secondary reset" value="Đặt lại">
                                <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">
                                    Hủy
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>*@
            <div class="modal fade" id="addCustomer" tabindex="-1" aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="#" class="addForm">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">
                                    Thêm nhanh khách hàng mới
                                </h5>
                            </div>
                            <div class="modal-body row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Tên khách hàng *</label>
                                    <input type="text" class="form-control validate important" id="customer"
                                           placeholder="Nhập tên khách hàng">
                                    <div id="customer-feedback" class="feedback"></div>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Số điện thoại *</label>
                                    <input type="text" class="form-control validate important" id="phone"
                                           placeholder="Nhập số điện thoại">
                                    <div id="phone-feedback" class="feedback"></div>
                                </div>
                                @*<div class="col-12 mb-3">
                                    <label class="form-label">Tỉnh/Thành phố *</label>
                                    <select class="single-select validate important" id="province">
                                        <option value="" selected>Chọn Tỉnh/Thành Phố</option>
                                    </select>
                                    <div id="province-feedback" class="feedback"></div>
                                    <input id="provinceString" hidden class="form-control" />
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Quận/Huyện *</label>
                                    <div class="col-sm-10 ">
                                        <select class="single-select validate important" id="district">
                                            <option selected value="">Chọn Quận/Huyện</option>
                                        </select>
                                        <div id="district-feedback" class="feedback"></div>
                                        <input hidden id="districtString" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Phường/Xã *</label>
                                    <div class="col-sm-10 ">
                                        <select class="single-select validate important" id="ward">
                                            <option selected value="">Chọn Phường/Xã</option>
                                        </select>
                                        <div id="ward-feedback" class="feedback"></div>
                                        <input hidden id="wardString" class="form-control" />
                                    </div>
                                </div>*@
                                <div class="col-12 mb-3">
                                    <label class="form-label">Địa chỉ *</label><br>
                                    <textarea id="address" class="form-control validate important" 
                                              cols="30" rows="3" placeholder="Nhập địa chỉ"></textarea>
                                    <div id="address-feedback" class="feedback"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <input type="button" class="btn btn-primary reset submit" value="Lưu"
                                       id="submitcustomer" data-bs-dismiss="modal">
                                <input type="reset" class="btn btn-secondary reset" value="Đặt lại">
                                <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">
                                    Hủy
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--end page-content-wrapper-->
</div>
<!--end page-wrapper-->

@section Scripts
{
    <script>
        $('.single-select').select2({
            theme: 'bootstrap4',
            width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
            placeholder: $(this).data('placeholder'),
            allowClear: Boolean($(this).data('allow-clear')),
        });

        
    </script>
    @*<script src="~/mgmt-lib/template/assets/js/order_DataTest_Update247.js"></script>*@
    <script src="~/js/Order.js"></script>
    <script src="~/js/ValidateOrder.js"></script>
    <script src="~/js/address.js"></script>
}